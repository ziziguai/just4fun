{include file='ck1sh/_partials/head_inc.html'}
<body>
	<!--顶部警告框-->
	<div class="topWarn"></div>
	<!--单个添加SKU弹窗 start-->
	<div class="TCGB" id="sellSKUSetTCOne" data-id="add" sale-id='' del-id="">
		<div class="TCCON sellSKUSetTCOneCon">
			<h2>
				<span>添加销售SKU</span>
				<b class="TCCloseBtn">关闭</b>
			</h2>
			<div class="sellSKUSetTCOneBody">
				<p>
					<span>销售SKU</span>
					<input type="text" name="saleSku"/>
					<b>*</b>
				</p>
					<div class="skuTable">
					<h4>产品 SKU信息<b>*</b></h4>
						<table>
							<thead><tr><th>产品SKU</th><th>数量</th><th>操作</th></tr></thead>
							<tbody>
							</tbody>
						</table>
						<a href="javascript:;" class="btn btn-mini addTr">添加</a>
					</div>
			</div>
			<div class="TCFooter">
				<span></span>
				<input type="button" value="保存" class="btn btn-primary" id="saleSkuSave" />
				<input type="button" value="取消" class="btn TCCloseBtn" />
			</div>
		</div>
	</div>
	<!--单个添加SKU弹窗 end-->
	<!--批量添加SKU弹窗 start-->
	<!--
	<div class="TCGB sellSKUSetTCTwo">
		<div class="TCCON sellSKUSetTCTwoCon">
			<h2>
				<span>批量添加销售Sku设置</span>
				<b class="TCCloseBtn">关闭</b>
			</h2>
			<div class="sellSKUSetTCTwoBody">
				<p>
					<input type="file" name="" id="" />
					<input type="button" value="上传" class="btn btn-primary"/>
				</p>
					导入Excel模板示例：
				<table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>SalesSku </th><th>Sku1 </th><th>Quantity1 </th><th>Sku2 </th><th>Quantity2 </th>
                        </tr>
                    </thead>
                    <tbody>
                    	<tr><td>abc4</td><td>abc</td><td>4</td><td></td><td></td></tr>
                   		<tr><td>bundle</td><td>pen</td><td>2</td><td>book</td><td>1</td></tr>
                	</tbody>
				</table>
				<p>温馨提示</p>
				<p>excel表头请参照导入Excel模板示例；</p>
				<p>excel每行代表一个销售Sku，每行可以添加多个产品Sku；</p>
				<p>如果有更多产品Sku，可以自行添加列 如：Sku3 Quantity3 （4、5、6···依次类推）</p>
			</div>
		</div>
	</div>-->
	<!--批量添加SKU弹窗 end-->
	<div class="wrap">
		<ul class="breadcrumb" style="background-color: transparent;">
			<li><a href="http://demo.chukou1.cn/Client/Home/Home.aspx">首页</a>&nbsp;<span class="divider">/</span></li>
		    <li><a href="?r=oms/home">Selling Helper</a>&nbsp;<span class="divider">/</span></li>
		    <li class="active">销售SKU设置</li>
	    </ul>
		<div class="tabHead">
		</div>
		<div class="content">
			<div class="tabBody">
				<b>&nbsp;&nbsp;&nbsp;销售SKU设置</b><br/><br/>
				   &nbsp;&nbsp;&nbsp;销售SKU设置允许设置销售SKU与产品SKU的绑定关系；先设置好产品SKU，然后设置销售SKU绑定规则；销售SKU设置没有批量导入功能，后续添加。<br/>
				<div class="tabBodyHead">
					<div class="sel">
						<div class="selLeft">
							<!-- <form class='form-search' style='float:left;'> -->
								<div class='input-append'>
									<div class="btn-group" id="searchSKU" name="keySKU">
										<a class="btn dropdown-toggle"  name="searchKey" data-toggle="dropdown">
											销售SKU</a>
											<a class='btn dropdown-toggle' data-toggle='dropdown'><span class='caret'></span>
										 </a>
										<ul class="dropdown-menu">
											<li><a href='javascript:;' class="searchSku" data-value='1'>销售SKU</a></li>
											<li><a href='javascript:;' class="searchSku" data-value='2'>产品SKU</a></li>
										</ul>
									</div>
									<!-- 发货服务选中值，默认未选值为0 -->
									<input name="SkuOptionsValue" value="1" style="display: none;" />
									<input type='text' class='search-query'>
									<button type='submit' class='btn btn-primary' id="srcrchBtn" disabled> 查 询 </button>
								</div>
							<!-- </form>-->
						</div>
						<div class="selRight">
							<a class="btn btn-warning" id="addMatchRule">单个添加</a>
							<!-- <a class="btn btn-warning">批量添加</a> -->
							<a class="btn btn-warning" id="delBulkSaleSku">删除</a>
						</div>
						<div class="clear"></div>
					</div>
				</div>
				<div class="tabBodyCon">
					<table class="table table-striped table-hover">
						<thead id="saleSkuDisplayTableTitle">
							<tr>
								<th>
									全选 <input type="checkbox" />
								</th>
								<th>销售SKU</th>
								<th>产品SKU</th>
								<th width="10%">操作</th>
							</tr>
						</thead>
						<tbody id="listsalesku">
							<tr><td colspan="15" align="center">&hellip;</td></tr>
						</tbody>
					</table>
					</div>
					<div class='pagination pagination-small pagination-right' id="paginationNavBar">
					</div>
				</div>
			</div>
		</div>
	<script type="text/javascript" src="public/template/ck1sh/js/jquery-1.8.3.js"></script>
	<script type="text/javascript" src="public/template/ck1sh/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="public/template/ck1sh/js/index.js"></script>
	<script type="text/javascript" src="public/template/ck1sh/js/oms.js"></script>
	{literal}
	<script>
		"use strict";
		require(['util', 'oms'], function(util, oms){
			$(function() {
				var global_info = {
					'page': undefined,		// 分页页码
					'pageSize': undefined,	// 分页大小
					'searchID': undefined,	// 查询类型
					'searchCon': undefined,	// 查询SKU
				}; // 全局信息变量
				var $oSellSKUSetTCOne = $('#sellSKUSetTCOne');
				var $oSkuTable = $oSellSKUSetTCOne.find(".skuTable");
				var $oSearchSKU = $('#searchSKU');
				var $oSearchInput = $('.search-query');
				var $oSearchBtn = $('#srcrchBtn');

				$('input[name=SkuOptionsValue]').val(1);
				$('body').attr('id', 'sellSKUSet');
				listSaleSku();
				//-----------------------------------点击添加按钮弹窗-----------------------------------
				$('#addMatchRule').on('click', function() {
					$('#sellSKUSetTCOne h2 span').html('添加销售SKU');
					$('#sellSKUSetTCOne').slideDown(200);
					$('#sellSKUSetTCOne input[type=text]').val('');
					$('#sellSKUSetTCOne').data('id','add');
					var tr = '<tr class="removetr"><td><input  name="sku" type="text" /></td><td><input name="number" type="text" /></td><td><a href="javascript:;" class="btn btn-mini delTr">删除</a></td></tr>';
					$("#sellSKUSetTCOne table tbody").append(tr);
				});

				var trLength=0;
				//-----------------------------------添加产品SKU行-----------------------------------
				$(".addTr").on("click",function(){
					var flag = true;
					$oSkuTable.find('input[type="text"]').each(function(index, item) {
						var $item = $(item);
						if (!$item.val()) {
							flag = false;
							$item.addClass('redBorder');
							return;

						} else {
							$item.removeClass('redBorder');
						}
					});
					if (flag) {
						var tb = '<tr class="removetr" sku-id=0><td><input  name="sku" type="text" /></td><td><input name="number" type="text" /></td><td><a href="javascript:;" class="btn btn-mini delTr">删除</a></td></tr>';
						$oSellSKUSetTCOne.find(".sellSKUSetTCOneCon .delTr").off( "click" )
						$(this).parent().find("table tbody").append(tb);
						trLength = 0;
						$oSkuTable.find('.delTr').removeClass('disabled');
					}
				});

				//-----------------------------------删除产品SKU行-----------------------------------

				$oSkuTable.on("click", '.delTr', function(){
					var $this = $(this);
					if ($this.hasClass('disabled')) {
						return;
					}
					trLength = $oSkuTable.find('.removetr').length;

					if(trLength > 1){
						var saleID = $oSellSKUSetTCOne.attr("del-id");
						var skuID = $(this).parent().parent().attr('sku-id');
						if(skuID!=0){
							$oSellSKUSetTCOne.attr("del-id",saleID+','+skuID);
						}
						$this.parents('tr').remove();
						if ($oSkuTable.find('.removetr').length === 1) {
							$oSkuTable.find('.delTr').addClass('disabled');
						}
					} else {
						util.showTips('error', '不允许删除，至少应有一条产品SKU信息！');
					}
				});

				//-----------------------------------添加SKU关闭弹窗-----------------------------------
				var change = '';
				$('.TCCloseBtn').on("click",function(){
					$oSellSKUSetTCOne.slideUp(200);
					$oSellSKUSetTCOne.find("table tbody .removetr").remove();
					$oSellSKUSetTCOne.find(".sellSKUSetTCOneBody input").val('');
					$oSellSKUSetTCOne.attr('sale-id','');
					$oSellSKUSetTCOne.attr('del-id','');
					change = '';
				});

				//-----------------------------------复选框全选-----------------------------------
				util.checkAllBoxes($('.tabBodyCon table thead :checkbox'), $('.tabBodyCon table tbody :checkbox'));
				$oSearchSKU.on("click",function(){
					// var currentItem = $(event.currentTarget);
					// 选中，改变显示内容，填充选中值
				});
				//-----------------------------------批量删除销售SKU-----------------------------------
				$("#delBulkSaleSku").on("click",function(){
					var getAllId_str = util.getAllId($('.tabBodyCon tbody tr input[type=checkbox]:checked'));
						if(getAllId_str.length == 0){
							util.showTips('warning', '请勾选复选框!');
							return;
						}
					var conf = confirm('您确认删除选定的销售SKU吗？');
					if(conf == true){
						$.ajax({
							'url':'?r=oms/shproduct/delsalesku&saleid='+getAllId_str,
							success:function(data){
								if(data.code == '003'){
									util.showTips('success', '删除销售SKU成功!');
								}else{
									util.showTips('warning', '删除销售SKU失败!');
								}
								setTimeout(function() {
									location.reload();
								}, 800);
							}
						})
					}
				});

				// 判断销售SKU是否为空
				var saleSkuInput = $('input[name = saleSku]');
				saleSkuInput.change(function() {
					if (saleSkuInput.val().length == 0) {
						saleSkuInput.addClass('redBorder');
					}else {
						saleSkuInput.removeClass('redBorder');
					}
				});
				//-----------------------------------保存销售SKU-----------------------------------
				$('.sellSKUSetTCOneCon').on('keydown','.sellSKUSetTCOneBody input:text',function(){
					change = '1';
				});
				$("#saleSkuSave").on("click", function(){
					var $this = $(this);
					if($oSellSKUSetTCOne.data('id') == 'add'){

						//-----------------------------------添加销售SKU开始-----------------------------------
						var dataJosn = "[";
						var saleSku = $("input[name = saleSku]").val();
						var trLeng = $this.parents(".sellSKUSetTCOneCon").find("table tbody tr");
						var pregQuan = /^[0-9]*[1-9][0-9]*$/;
						var skuNumber = '';
						var skuExist  = '';
						var SKUArr=[];
						var nary=[];
						if (saleSku.length == 0) {
							$('input[name = saleSku]').addClass('redBorder');
							return;
						}
						$.each(trLeng,function(index,item){
							var productSku = $(item).find("input[name = sku]").val();
							SKUArr[index]=productSku;
							var productNumber = $(item).find("input[name = number]").val();
							if(!pregQuan.test(productNumber)){
								skuNumber = 1;
							}else if(!productSku ){
								skuExist = 1;
							}
							dataJosn+="{\"product_sku\":\""+productSku+"\",\"quantity\":"+productNumber+"},";
						})
						nary=SKUArr.sort();
						for(var i=0;i<nary.length;i++){
							 if (nary[i]==nary[i+1]){
								 var repeat = 1;
							 }
						 }
						dataJosn = dataJosn.substring(0, dataJosn.length - 1);
						dataJosn += "]";
						if(skuNumber == 1 ){
							skuNumber = 0;
							util.showTips('warning','产品SKU的数量必须大于0，请检查数量和格式!');return '';
						}else if(skuExist == 1){
							skuExist = 0 ;
							util.showTips('warning','产品Sku不存在，请检查数量和格式!');return '';
						}else if(repeat == 1){
							repeat = 0;
							util.showTips('warning','产品Sku重复，请检查数量和格式!');return '';
							return false;
						}else{
							$.ajax({
								type:"POST",
								url : "?r=oms/shproduct/AddSaleSku",
								data:{
									product:dataJosn,
									Sku: saleSku
								},
								success:function(result){
									if(result.code=="003"){
										util.showTips('success', '添加销售SKU成功!');
										$oSellSKUSetTCOne.find(".sellSKUSetTCOneBody input").val('');
									}else{
										util.showTips('warning', result.msg);
										return;
									}
									setTimeout(function() {
										window.location.reload();
									}, 800)
								}
							})
						}
						//-----------------------------------添加销售SKU结束-----------------------------------
					} else{
						//-----------------------------------编辑销售SKU-----------------------------------
						var dataJosn = "[";
						var saleID = $oSellSKUSetTCOne.attr("sale-id");
						var delID = $oSellSKUSetTCOne.attr("del-id");
						var saleedID = $oSellSKUSetTCOne.data('id');
						var saleSku = $("input[name = saleSku]").val();
						var trLeng = $this.parents(".sellSKUSetTCOneCon").find("table tbody tr");
						var pregQuan = /^[0-9]*[1-9][0-9]*$/;
						var skuNumber = '';
						var skuExist = '';
						var SKUArr=[];
						var nary=[];
						$.each(trLeng,function(index,item){
							var productSku = $(item).find("input[name = sku]").val();
							var productNumber = $(item).find("input[name = number]").val()
							var productID	= $(item).attr("sku-id");
							SKUArr[index]=productSku;
							if(!pregQuan.test(productNumber)){
								skuNumber = 1;
							}else if(!productSku ){
								skuExist = 1;
							}
							dataJosn+="{\"product_sku\":\""+productSku+"\",\"quantity\":"+productNumber+",\"sku_id\":\""+productID+"\"},";
						})
						dataJosn = dataJosn.substring(0, dataJosn.length - 1);
						dataJosn += "]";
						nary=SKUArr.sort();
						for(var i=0;i<nary.length;i++){
							 if (nary[i]==nary[i+1]){
								var repeat = 1;
							 }
						 }
						if(change == ''&& delID == 0){
							util.showTips('warning','内容没有修改！');
							return false;
						}else if(skuNumber == 1 ){
							skuNumber = 0;
							util.showTips('warning','产品SKU的数量必须大于0，请检查数量和格式!');return '';
						}else if(skuExist == 1){
							skuExist = 0 ;
							util.showTips('warning','产品Sku不存在，请检查数量和格式!');return '';
						}else if(repeat == 1){
							repeat = 0;
							util.showTips('warning','产品Sku重复，请检查数量和格式!');return '';
							return false;
						}else{
							$.ajax({
								type:"POST",
								url : "?r=oms/shproduct/EditSaleSku",
								data:{
									delid:delID,
									salesku:saleSku,
									product:dataJosn,
									saleid:saleID,
									saleedid:saleedID
								},
								success:function(result){
									if(result.code=='003'){
										util.showTips('success', result.msg);
										$(".sellSKUSetTCOneBody input").val('');
										setTimeout(function() {
											window.location.reload();
										}, 800);
									} else{
										util.showTips('warning', result.msg);
									}
								}
							});
						}
					}
				});
				//------------------------------保存销售SKU结束-----------------------------------

				//------------------------------查询开始-----------------------------------
				$(".searchSku").on("click",function(){
					$oSearchBtn.prop('disabled', false);
					$oSearchSKU.children("[name=searchKey]").text($(this).text());
					$('input[name=SkuOptionsValue]').val($(this).data('value'));
				});

				$oSearchInput.on('keyup', function() {
					$oSearchBtn.prop('disabled', false).css('cursor', 'pointer');
				});

				//点击查询
				$oSearchBtn.on("click",function(){
					$oSearchBtn.prop('disabled', true).css('cursor', 'no-drop');
					global_info.searchID = $('input[name=SkuOptionsValue]').val();
					global_info.searchCon = $oSearchInput.val();
					// 重置分页到默认页
					global_info.page = undefined;
					listSaleSku();
				});

				//---------------获取销售SKU列表开始-------------------------

				function listSaleSku(pageInfo){
					if(pageInfo != undefined){
						global_info.page = pageInfo.page;
						global_info.pageSize = pageInfo.pageSize;
					}
					//调用AJAX获取数据
					$.ajax({
						type:'POST',
						url:'?r=oms/shproduct/SaleSkuList',
						data:{
							type:global_info.searchID,
							sku:global_info.searchCon,
							pageSize: global_info.pageSize,
							page:global_info.page
						},
						success:function(result){
							var saleSkuList = $("#listsalesku");
							if(result){
								var listSale = result.sale;
								if(listSale && listSale.length>0){
									var template = '';
									saleSkuList.children('tr').remove();
									$.each(listSale,function(index,item){
										template = '<tr data-id="'+item.salesku+'"><td><input type="checkbox" /></td>'
											+'<td><span id="List_saleSku">'+item.salesku+'</span></td>'
											+'<td><span>'+item.sku+'</span></td>'
											+'<td width="10%"><a href="javascript:;" class="btn editSaleSku">编辑</a>'
											+'<a href="javascript:;" class="btn delSaleSku">删除</a></td></tr>';
										// 绑定一行销售SKU数据
										saleSkuList.append(template);
									});
								} else{
									// 显示数据空
									saleSkuList.children('tr').remove();
									saleSkuList.append('<tr><td colspan="' + $("#saleSkuDisplayTableTitle").children("tr").children("th").length
											+ '" align="center">无数据</td></tr>');
								}
								var pageInfo = result.page;
								oms.refreshPaginationNavBar(pageInfo.page,pageInfo.pageSize,pageInfo.count,listSaleSku);
							} else{
								// 显示请求错误
								saleSkuList.children("tr").remove();
								saleSkuList.append('<tr><td colspan="' + $("#saleSkuDisplayTableTitle").children("tr").children("th").length
									+ '" align="center"><span class="text-error">请求出错</span></td></tr>');
							}
							util.checkAllBoxes($('.tabBodyCon table thead :checkbox'), $('.tabBodyCon table tbody :checkbox'));

							//------------------------删除单个销售SKU开始------------------------------
							$(".delSaleSku").on('click',function(){
								var conf = confirm('您确认删除该销售SKU吗？');
								if(conf == true){
									var saleID = $(this).parents('tr').data('id');
									$.ajax({
										url:'?r=oms/shproduct/delsalesku&saleid='+saleID,
										success : function(data){
											if(data.code=='003'){
												util.showTips('success',"删除销售SKU成功!");
											}else{
												util.showTips('warning', "删除销售SKU失败!");
											}
											setTimeout(function() {
												window.location.reload();
											}, 800);
										}
									});
								}
							});
							//------------------------删除单个销售SKU线束------------------------------

							//---------------------------------编辑销售SKU、弹窗开始--------------------------
							$(".editSaleSku").on("click",function(){
								$('#sellSKUSetTCOne').slideDown(200);
								$('#sellSKUSetTCOne').data('id','edit');
								var id = $(this).parents('tr').data("id");
								$('#sellSKUSetTCOne').data('id',id);
								var saleSku = $(this).parent().parent().find("#List_saleSku").text();
								$("#sellSKUSetTCOne h2 span").html("编辑销售SKU");
								//获取销售SKU详情
								$.ajax({
									url : '?r=oms/shproduct/SaleSkuInfo&saleid='+id,
									success : function(data){
										var tr = '';
										$.each(data,function(index,item){
											tr +='<tr class="removetr" sku-id="'+item.sale_sku_id+'"><td><input  name="sku" type="text" value="'+item.product_sku+'" /></td><td><input name="number" type="text" value="'+item.quantity+'" /></td><td><a href="javascript:;" class="btn btn-mini delTr">删除</a></td></tr>';
										});
										$("#sellSKUSetTCOne .sellSKUSetTCOneBody input[name=saleSku]").val(saleSku);
										$("#sellSKUSetTCOne table tbody").append(tr);
									}
								});
							});
							//---------------------------------编辑销售SKU、弹窗结束--------------------------
						}
					});
				}
				//---------------获取销售SKU列表结束 -------------------------
			});
		});
	</script>
	{/literal}
</body>
</html>
