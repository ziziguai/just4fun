{include file='ck1sh/_partials/head_inc.html'}
<body>
	{literal}
	<style>.requiredError{display:none;color:red;}</style>
	{/literal}
	<!--顶部警告框-->
	<div class='loading'></div>
	<div class="topWarn"></div>
	<div class="wrap">
		<ul class="breadcrumb" style="background-color: transparent;">
			<li><a href="http://demo.chukou1.cn/Client/Home/Home.aspx">首页</a>&nbsp;<span class="divider">/</span></li>
		    <li><a href="?r=oms/home">Selling Helper</a>&nbsp;<span class="divider">/</span></li>
		    <li><a href="?r=oms/shproduct/productsku">产品信息管理</a>&nbsp;<span class="divider">/</span></li>
		    <li class="active">批量导入</li>
	    </ul>
		<div class="tabHead">
		</div>
		<div class="content">
			<div class="tabBody">
				<div class="tabBodyHead">
					<div class="sel">
						<div class="selLeft">
						<form method="POST" enctype="multipart/form-data">
							<input type="file" id="filename" name="filename" id=""/><input type='submit' id="doCheck" name='submit' value='导入' class="btn btn-warning" />
							<a id="downexcel" class="btn btn-warning">模板下载</a>
						</form>
							<ul class="upLoadUl">温馨提示：
								<li>导入的产品信息将会同步到产品型号；</li>
								<li>为了能够顺利为您匹配产品信息到订单，请您编辑excel时保持销售平台SKU与产品名称的一致；</li>
								<li>产品名称(SKU)中不能含有以下特殊符号：' " < > &，分别是：单引号、双引号、小于号、大于号及and符号；</li>
								<li>注意：您每次导入的最大SKU数为2000条，大于2000条请分多次导入，谢谢合作！</li>
							</ul>
						</div>
						<div class="selRight">
							<a class="btn btn-warning" href = 'index.php?r=oms/shproduct/productsku'>返回</a>
						</div>
						<div class="clear"></div>
					</div>
				</div>
				<div class="tabBodyCon" id="batchList">
					<a href="javascript:;" id ="productAll" class="btn disabled">显示全部</a>
					<a href="javascript:;" id="productError" class="btn disabled">只显示错误 </a>
					{if ($quantity != '')}
					<br/><b>成功读取{$quantity}个产品型号</b>
					{/if}
					<form method="POST" enctype="multipart/form-data" name='product' id="fproduct" >
						<table id="bulk" class="table table-striped table-hover" product-error="{$producterror}">
							<thead>
								<tr>
									<th>SKU<b>*</b></th>
									<th>产品类别</th>
									<th>重量(g)<b>*</b></th>
									<th>包装规格(cm)<b>*</b></th>
									<th>申报名称<b>*</b></th>
									<th>申报价格<b>*</b></th>
									<th>备注</th>
									<th>检验</th>
								</tr>
							</thead>
								<tbody style="display:none">
									{foreach from=$product key=k item=i}
									<tr id="product{$k}" data-id="{$i.k}">
										<td>
											<input type="text" class="sku" id="sku{$k}" name="product[{$k}][sku]" value="{$i.0}" />
										</td>
										<td>
											<input type="text" class="category not-sp" id="category{$k}" name="product[{$k}][category]" value="{$i.1}" />
										</td>
										<td>
											<input type="text" class="weight" id="weight{$k}" name="product[{$k}][weight]" value="{$i.2}" />
										</td>
										<td>
											<input type="text" class="packing" id="packing{$k}" name="product[{$k}][packing]" value="{$i.3}" />
										</td>
										<td>
											<input type="text" class="declareName" id="declareName{$k}" name="product[{$k}][declare_name]" value="{$i.4}" />
										</td>
										<td>
											<input type="text" class="declareValue" id="declareValue{$k}" name="product[{$k}][declare_price]" value="{$i.5}" />
										</td>
										<td>
											<input type="text" class="remark not-sp"  id="remark{$k}" name="product[{$k}][remark]" value="{$i.6}" />
										</td>
										{if ($i|@end)== 1}
											<td data-name="on" class ="on" id="on{$k}">通过</td>
										{else}
											<td data-name="off" class ="on" id="on{$k}" style="color:red;">未通过</td>
										{/if}
									</tr>
								{/foreach}
								</tbody>
						</table>
						<div class="pagination pagination-small pagination-right" id="paginationNavBar">
							<ul></ul>
						</div>
						<p class="btn-box"><input type="submit" href="javascript:;" id="btnSub"  class="btn btn-primary" value="提交"></p>
						<p class="error-box">请先导入产品信息文件，可下载模板进行修改填写！</p>
					</form>
				</div>
			</div>
		</div>
	</div>
	{literal}
	<script>
		"use strict";
		require(['util'], function(util){
			$('body').attr('id', 'bulkImport');
			/**
			 * 分页方法
			 * @author Super
			 * @author $oContent 追加至此的表格
			 * @param currentPage 当前页数
			 * @param countPage 总的页数
			 */
			function paging($oContent, currentPage, pageSize, count) {
				if (count === 0) {
					$oContent.find('ul').html('');
					return;
				}
				var countPage = Math.ceil(count / pageSize);	// 总页数
				var strPrevPageHtml = '<li class="page-home"><a href="javascript:;" data-page="1">首页</a></li>' +
					'<li class="page-prev"><a href="javascript:;" data-page="' + (currentPage - 1) + '">&lt;</a></li>';
				var strNextPageHtml = '<li class="page-next"><a href="javascript:;" data-page="' + (currentPage + 1) + '">&gt;</a></li>' +
					'<li class="page-last"><a href="javascript:;" data-page="' + countPage + '">尾页</a></li>';
				var strCountPageHtml = '<li class="select-size"> 每页 <select><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="30">30</option><option value="50">50</option><option value="100">100</option></select>' +
					' 条，共 <strong>' + countPage + '</strong> 页 <strong>' + count + '</strong> 条</li>';
				var strPageHtml = '';
				if (countPage == 1) {
					strPageHtml = '<li class="page-base"><a data-page="1" href="javascript:;">1</a></li>';

				} else if (countPage <= 5) {
					for (var i = 1; i <= countPage; i ++) {
						strPageHtml += '<li class="page-base"><a href="javascript:;" data-page="' +
						i + '">' +
						i + '</a></li>';
					}

				} else {
					if (currentPage < 5){
						for (var i = 1; i <= 5; i ++) {
							strPageHtml += '<li class="page-base"><a href="javascript:;" data-page="' +
							i + '">' +
							i + '</a></li>';
						}

					} else if (countPage - 5 < currentPage) {
						for (var i = countPage - 5; i <= countPage; i ++) {
							strPageHtml += '<li class="page-base"><a href="javascript:;" data-page="' +
							i + '">' +
							i + '</a></li>';
						}

					} else {
						for (var i = currentPage - 2; i <= currentPage + 2; i ++) {
							strPageHtml += '<li class="page-base"><a href="javascript:;" data-page="' +
							i + '">' +
							i + '</a></li>';
						}
					}
				}

				$oContent.find('ul').html(strPrevPageHtml + strPageHtml + strNextPageHtml + strCountPageHtml).css('margin-right', '0');

				/* 当前页设置样式 */
				$oContent.find('li.page-base a').each(function(index, item) {
					var $item = $(item);
					if (+$item.data('page') === currentPage) {
						$item.closest('li').addClass('active');
					}
				});

				/* 设置每页显示几条 */
				$oContent.find('select option[value="' + pageSize + '"]').prop('selected', true);

				/* 当前页为第一页时 */
				if (currentPage === 1) {
					$oContent.find('li.page-home, li.page-prev').addClass('disabled');
				}

				/* 当前页为最后一页时 */
				if (currentPage === countPage) {
					$oContent.find('li.page-next, li.page-last').addClass('disabled');
				}
			}

			$(function() {
				var $oFproduct = $('#fproduct');
				// 对导入的文件列验证
				var $oListBox = $('#bulk'); // 列表面板
				if($oListBox.attr('product-error')){
					util.showTips('error', '工作簿“产品信息表”缺少必要的列，缺少列: ' + $oListBox.attr('product-error'), 'normal');
				}

				var bFlag = false;
				var aError = [];
				var $oPageBox = $('#paginationNavBar');	// 页码面板
				var iListCount = $oListBox.find('tbody tr').length;	// 列表总数
				var $iPageSize = 15;	// 默认每页显示15条
				var $iCurrentPage = 1;	// 默认当前第一页
				var $sIsError = false;	// 是否显示错误
				var $btnProductError = $("#productError");
				var $btnProductAll = $("#productAll");

				if (iListCount) {
					$btnProductError.removeClass('disabled');
					$btnProductAll.removeClass('disabled');
				}

				$('body').on('click', '#shTipsModal .confirm, #shTipsModal .close', function() {
					if (bFlag) {
						location.href = 'index.php?r=oms/shproduct/productsku';
					}
					$('#shTipsModal').slideUp(200);
					for (var i = 0, len = aError.length; i < len; i++){
						$('#product' + (aError[i] - 1)).find('td').css('backgroundColor', '#faa');
					}
					$('table tbody tr').hide();
					$iCurrentPage = Math.ceil(aError[0] / + $iPageSize);
					$('table tbody tr:lt(' + ($iCurrentPage * $iPageSize) + '):gt('+ (($iCurrentPage - 1) * $iPageSize) + ')').show();
					$('table tbody tr:eq('+ (($iCurrentPage - 1) * $iPageSize) + ')').show();
					paging($oPageBox, $iCurrentPage, $iPageSize, iListCount);
				});

				// 显示错误的信息
				(function () {
					var patrnSku=/^[^\'\"\<\>\&]*$/;
					var patrnPack = /^\d+(\*\d+){2}$/;

					$oListBox.find("tbody tr").each(function(i,t){
						$(t).find("input:not('.not-sp')").each(function(index, item){
							var $item = $(item);
							switch($item.attr("class")) {
								// 产品SKU验证
								case "sku":
									if (!patrnSku.test($item.val()) || $item.val().length >= 50 || $item.val()==''){
										$item.addClass("redBorder");
									}
								break;
								// 产品包装规格验证
								case "packing":
									if(!patrnPack.test($item.val()) || $item.val()==''){
										$item.addClass("redBorder");
									}
								break;
								// 产品重量验证
								case "weight":
									if(!$.isNumeric($item.val()) || $item.val()[0] == '.' || $item.val()==''){
										$item.addClass("redBorder");
									}
								break;
								// 申报价值验证
								case "declareValue":
									if(!$.isNumeric($item.val()) || $item.val()[0] == '.' || $item.val()==''){
										$item.addClass("redBorder");
									}
								break;
								case "declareName":
									if($item.val()==''){
										$item.addClass("redBorder");
									}
								break;
								default:
									$item.removeClass("redBorder");
								break;
							}
						});
					});
					$('table tbody').show();
					$('table tbody td[data-name=on]').closest('tr').hide();
				})();

				// 产品信息字段处理
				$("td input").blur(function(){
					var self = $(this);
					var flag = 0;
					var patrnSku=/^[^\'\"\<\>\&]*$/;
					var patrnPack = /^\d+(\*\d+){2}$/;
					self.parents("tr").find("input:not('.not-sp')").each(function(index, item) {
						var $item = $(item);
						if (!$item.val()) {
							$item.addClass("redBorder");
							flag ++;
							return;
						} else {
							$item.removeClass("redBorder");
							switch($item.attr("class")) {
								// 产品SKU验证
								case "sku":
									if (!patrnSku.test($item.val()) || $item.val().length >= 50){
										$item.addClass("redBorder");
										flag ++;
									}else{
										$item.removeClass("redBorder");
									}
									break;
								// 产品包装规格验证
								case "packing":
									if(!patrnPack.test($item.val())){
										$item.addClass("redBorder");
										flag ++;
									}else{
										$item.removeClass("redBorder");
									}
									break;
								// 产品重量验证
								case "weight":
									if(!$.isNumeric($item.val()) || $item.val()[0] == '.'){
										$item.addClass("redBorder");
										flag ++;
									}else{
										$item.removeClass("redBorder");
									}
									break;
								// 申报价值验证
								case "declareValue":
									if(!$.isNumeric($item.val()) || $item.val()[0] == '.'){
										$item.addClass("redBorder");
										flag ++;
									}else{
										$item.removeClass("redBorder");
									}
									break;
								default:
									$item.removeClass("redBorder");
									break;
							}
						}

					});
					if (flag>0) {
						self.parents("tr").find("td").eq(-1).attr("data-name","off");
						self.parents("tr").find("td").eq(-1).text("不通过");
					} else {
						self.parents("tr").find("td").eq(-1).attr("data-name","on");
						self.parents("tr").find("td").eq(-1).removeAttr("style");
						self.parents("tr").find("td").eq(-1).text("通过");
					}

				}).on('change', function() {
					$(this).closest('tr').addClass('changed');
				});

				// 验证导入数据
				$("#doCheck").click(function(){
					var file = $("#filename").val();
					if(file =='' || file == null){
						util.showTips('warning', '请先选择文件!');
						subBtn.hide();
						$oPageBox.hide();
						return false;
					}
					$('.loading').show();
					var position = file.lastIndexOf(".");
					if(position<0){
						util.showTips('warning', '请先选择文件!');
						return false;
					}
					var ext = file.substring(position+1,file.length);
					if(ext=="xlsx" || ext=="xls"){
						return true;
					}else{
						$('.loading').hide();
						util.showTips('warning', "上传文件并不是.xls或者.xlsx格式，无法处理");
						return false;
					}
				});

				// 模板下载
				$("#downexcel").on("click",function(){
					$.ajax({
						url: '?r=oms/shproduct/DownProductExcel',
						success:function(result){
							util.idownload(result);
						}
					});
				});

				var subBtn = $('#btnSub').closest('p');
				var $errorBox = $oFproduct.find('.error-box').show();
				// 显示错误的产品信息
				$btnProductError.on('click',function(){
					if ($btnProductError.hasClass('disabled')) {
						return false;
					}

					$('table tbody tr').hide();
					$('table tbody td[data-name="off"]').parent('tr:lt(' + $iPageSize + ')').show();
					var $aError = $('table tbody td[data-name="off"]');

					if (!iListCount) {
						return false;
					}

					$errorBox.hide();

					iListCount = $aError.length;
					paging($oPageBox, 1, $iPageSize, iListCount);
					subBtn.show();
					$oPageBox.show();
					$sIsError = true;
				});

				// 显示所有产品信息
				$btnProductAll.on('click',function() {
					if ($btnProductAll.hasClass('disabled')) {
						return false;
					}

					$('table tbody tr:lt(' + $iPageSize + ')').show();
					iListCount = $oListBox.find('tbody tr').length;

					if (!iListCount) {
						$errorBox.show();
						return false;
					}

					$errorBox.hide();

					paging($oPageBox, 1, $iPageSize, iListCount);
					$sIsError = false;
					subBtn.show();
					$oPageBox.show();
				}).click();

				/* 点击页码 */
				$oPageBox.on('click', 'a', function() {
					var self = $(this);
					var $oParent = $(this).closest('li');
					if ($oParent.hasClass('active') || $oParent.hasClass('disabled')) {
						return;
					}

					$('table tbody tr').hide();
					$iCurrentPage = +self.data('page');
					$iPageSize = +$oPageBox.find('select').val();

					if ($sIsError) {
						$('table tbody td[data-name="off"]').parent('tr:lt(' + ($iCurrentPage * $iPageSize) + '):gt('+ (($iCurrentPage - 1) * $iPageSize) + ')').show();
						$('table tbody td[data-name="off"]').parent('tr:eq(' + ($iCurrentPage - 1) * $iPageSize + ')').show();
					} else {
						$('table tbody tr:lt(' + ($iCurrentPage * $iPageSize) + '):gt('+ (($iCurrentPage - 1) * $iPageSize) + ')').show();
						$('table tbody tr:eq('+ (($iCurrentPage - 1) * $iPageSize) + ')').show();
					}

					paging($oPageBox, $iCurrentPage, $iPageSize, iListCount);
				});

				/* 选择下拉菜单(每页显示几条) */
				$oPageBox.on('change', 'select', function() {
					var self = $(this);
					$('table tbody tr').hide();
					$iPageSize = self.val();

					if ($sIsError) {
						$('table tbody td[data-name="off"]').parent('tr:lt('+ $iPageSize + ')').show();
					} else {
						$('table tbody tr:lt('+ $iPageSize + ')').show();
					}

					paging($oPageBox, 1, $iPageSize, iListCount);
				});

				// 提交数据
				$oFproduct.on("submit", function(){
					if($oListBox.find("tbody tr").length === 0){
						return false;
					}
					var obj_arr = [];
					var su = 0;
					$('.loading').show();
					$oListBox.find("tbody tr").each(function(index, item) {
						if($(item).find("td").eq(-1).attr("data-name") == 'off'){
							su=1;
						}
						var inn_arr = [];
						$(item).find("input").each(function(ind, it) {
							inn_arr.push($(it).val());
						});
						obj_arr.push(inn_arr);
					});

					if(su == 1){
						$('.loading').hide();
						util.showTips('warning', "提交失败！表格存在错误！");
						return false;
					}

					if($oListBox.find("tbody tr").length == 0){
						return false;
					}

					//获取需要post的数据
					var jProductBox = {};
					$oFproduct.find('tbody tr.changed').each(function(index, item) {
						var $item = $(item), jProductItem = {}, $sOuterKey = '';
						$item.find('input').each(function(ind, it) {
							var $it = $(it);
							$sOuterKey = $it.attr('name').split(']')[0] + ']';
							var $sInnerKey = $it.attr('name').split('[')[2];
							jProductItem[ind] = $it.val();
						});
						jProductBox[$sOuterKey] = jProductItem;
					});

					$.ajax({
						type: 'POST',
						url: 'index.php?r=oms/shproduct/BulkProductSku',
						data: jProductBox,
						success: function(result){
							var re = result;
							var tem = '';
							var row = 1;
							var succ = 0;
							var fail = 0;
							var msg = '';
							for(var i = 0, iLen = re.length; i < iLen; i ++){
								if(re[i]['code'] == '003'){
									succ++;

								} else if(re[i]['code'] == '002'){
									fail = 1;
									tem += '第'+row+'行，SKU '+re[i]['Sku']+'有重复，或者已存在该产品,请查正! </br>';
									aError.push(row);
								} else{
									fail = 1;
									tem += '第'+row+'行，产品名称 '+re[i]['Sku']+'格式错误   ';
									aError.push(row);
								}
								row++;
							}
							if(succ>0 && fail==1){
								var info = '批量导入成功，记录数为：'+succ+'条。部分记录导入失败，详细信息：';
								msg = info+tem;
							} else if(succ>0 && fail==0){
								var info = '批量导入成功，记录数为：'+succ+'条。';
								msg = info+tem;
								bFlag = true;
							} else{
								msg = tem;
							}
							$('.loading').hide();
							util.showTipsX({extend: msg,confirm:true,delay:0});
						}
					});
					return false;
				});
			});
		});
	</script>
	{/literal}
</body>
</html>